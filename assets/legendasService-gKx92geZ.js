import{s as i,l as t}from"./index-CVImE_rs.js";const p=async()=>{try{const{error:r}=await i.from("legendas_fotos").select("count").limit(1);return r?(t.warn("Tabela legendas_fotos nÃ£o encontrada ou sem permissÃ£o:",r.message),!1):(t.debug("Tabela legendas_fotos acessÃ­vel"),!0)}catch(r){return t.warn("Erro ao testar tabela legendas_fotos:",r.message),!1}},f=async(r,o,a={})=>{try{let e=i.from("legendas_fotos").select("*").eq("imagem_url",r).eq("escola_id",o);a.ativo!==!1&&(e=e.eq("ativo",!0)),a.categoria&&(e=e.eq("categoria",a.categoria)),a.tipo_foto&&(e=e.eq("tipo_foto",a.tipo_foto));const{data:s,error:n}=await e.order("created_at",{ascending:!1});return n?(t.warn("Erro ao buscar legenda:",n.message),null):s&&s.length>0?s[0]:null}catch(e){return t.warn("Erro ao buscar legenda:",e.message),null}},w=async(r,o,a={})=>{try{if(t.debug(`ðŸ” Buscando legenda flexÃ­vel para: ${r} (escola: ${o})`),a.categoria||a.tipo_foto){t.debug("  ðŸ“‹ Tentativa 1: Busca com preferÃªncias especÃ­ficas");const u=await f(r,o,a);if(u)return t.debug("  âœ… Encontrada com preferÃªncias especÃ­ficas"),u}t.debug("  ðŸ“‹ Tentativa 2: Busca apenas por URL e escola");const{data:e,error:s}=await i.from("legendas_fotos").select("*").eq("imagem_url",r).eq("escola_id",o).eq("ativo",!0).order("created_at",{ascending:!1});if(s)t.warn("  âŒ Erro na busca por URL e escola:",s.message);else if(e&&e.length>0)return t.debug("  âœ… Encontrada por URL e escola"),e[0];t.debug("  ðŸ“‹ Tentativa 3: Busca incluindo legendas inativas");const{data:n,error:c}=await i.from("legendas_fotos").select("*").eq("imagem_url",r).eq("escola_id",o).order("created_at",{ascending:!1});if(c)t.warn("  âŒ Erro na busca incluindo inativas:",c.message);else if(n&&n.length>0)return t.debug("  âœ… Encontrada incluindo legendas inativas"),n[0];const l=r.split("/").pop();t.debug(`  ðŸ“‹ Tentativa 4: Busca por nome do arquivo: ${l}`);const{data:d,error:g}=await i.from("legendas_fotos").select("*").ilike("imagem_url",`%${l}`).eq("escola_id",o).eq("ativo",!0).order("created_at",{ascending:!1});if(g)t.warn("  âŒ Erro na busca por nome do arquivo:",g.message);else if(d&&d.length>0)return t.debug("  âœ… Encontrada por nome do arquivo"),d[0];return t.debug("  âŒ Nenhuma legenda encontrada com todas as estratÃ©gias"),null}catch(e){return t.warn("Erro ao buscar legenda flexÃ­vel:",e.message),null}},b=async r=>{try{const{data:o,error:a}=await i.from("legendas_fotos").insert([r]).select().single();if(a)throw a;return o}catch(o){throw t.error("Erro ao adicionar legenda:",o),o}},v=async(r,o)=>{try{const{data:a,error:e}=await i.from("legendas_fotos").update(o).eq("id",r).select().single();if(e)throw e;return a}catch(a){throw t.error("Erro ao atualizar legenda:",a),a}},h=async(r,o)=>{try{const{data:a,error:e}=await i.from("legendas_fotos").select("*").eq("imagem_url",r).eq("escola_id",o).eq("categoria","video").single();if(e){if(e.code==="PGRST116")return null;throw e}return a}catch(a){return t.warn("Erro ao buscar tÃ­tulo do vÃ­deo:",a.message),null}},m=async(r,o,a)=>{try{const e=await f(r,o,{ativo:!1});if(e){const{data:s,error:n}=await i.from("legendas_fotos").update({ordem:a,updated_at:new Date().toISOString()}).eq("id",e.id).select().single();if(n)throw n;return s}else{const n=(r.split("/").pop()||"Imagem").replace(/\.[^/.]+$/,"").replace(/[_-]/g," ")||"Imagem",{data:c,error:l}=await i.from("legendas_fotos").insert([{escola_id:o,imagem_url:r,legenda:n,ordem:a,ativo:!0,tipo_foto:"escola",categoria:"geral",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select().single();if(l)throw l;return c}}catch(e){throw t.error("Erro ao atualizar ordem da imagem:",e),e}},q=async(r,o)=>{try{return await Promise.all(r.map(({imageUrl:e,ordem:s})=>m(e,o,s)))}catch(a){throw t.error("Erro ao atualizar ordens das imagens:",a),a}};export{h as a,f as b,v as c,b as d,w as g,p as t,q as u};
