import{s as d,l as o}from"./index-AGgLKNpB.js";const h=async()=>{try{const{error:r}=await d.from("legendas_fotos").select("count").limit(1);return r?(o.warn("Tabela legendas_fotos nÃ£o encontrada ou sem permissÃ£o:",r.message),!1):(o.debug("Tabela legendas_fotos acessÃ­vel"),!0)}catch(r){return o.warn("Erro ao testar tabela legendas_fotos:",r.message),!1}},l=async(r,e,t={})=>{try{let a=d.from("legendas_fotos").select("*").eq("imagem_url",r).eq("escola_id",e);t.ativo!==!1&&(a=a.eq("ativo",!0)),t.categoria&&(a=a.eq("categoria",t.categoria)),t.tipo_foto&&(a=a.eq("tipo_foto",t.tipo_foto));const{data:n,error:s}=await a.order("created_at",{ascending:!1});return s?(o.warn("Erro ao buscar legenda:",s.message),null):n&&n.length>0?n[0]:null}catch(a){return o.warn("Erro ao buscar legenda:",a.message),null}},v=async(r,e,t={})=>{try{if(o.debug(`ðŸ” Buscando legenda flexÃ­vel para: ${r} (escola: ${e})`),t.categoria||t.tipo_foto){o.debug("  ðŸ“‹ Tentativa 1: Busca com preferÃªncias especÃ­ficas");const f=await l(r,e,t);if(f)return o.debug("  âœ… Encontrada com preferÃªncias especÃ­ficas"),f}o.debug("  ðŸ“‹ Tentativa 2: Busca apenas por URL e escola");const{data:a,error:n}=await d.from("legendas_fotos").select("*").eq("imagem_url",r).eq("escola_id",e).eq("ativo",!0).order("created_at",{ascending:!1});if(n)o.warn("  âŒ Erro na busca por URL e escola:",n.message);else if(a&&a.length>0)return o.debug("  âœ… Encontrada por URL e escola"),a[0];o.debug("  ðŸ“‹ Tentativa 3: Busca incluindo legendas inativas");const{data:s,error:i}=await d.from("legendas_fotos").select("*").eq("imagem_url",r).eq("escola_id",e).order("created_at",{ascending:!1});if(i)o.warn("  âŒ Erro na busca incluindo inativas:",i.message);else if(s&&s.length>0)return o.debug("  âœ… Encontrada incluindo legendas inativas"),s[0];const c=r.split("/").pop();o.debug(`  ðŸ“‹ Tentativa 4: Busca por nome do arquivo: ${c}`);const{data:u,error:g}=await d.from("legendas_fotos").select("*").ilike("imagem_url",`%${c}`).eq("escola_id",e).eq("ativo",!0).order("created_at",{ascending:!1});if(g)o.warn("  âŒ Erro na busca por nome do arquivo:",g.message);else if(u&&u.length>0)return o.debug("  âœ… Encontrada por nome do arquivo"),u[0];return o.debug("  âŒ Nenhuma legenda encontrada com todas as estratÃ©gias"),null}catch(a){return o.warn("Erro ao buscar legenda flexÃ­vel:",a.message),null}},b=async r=>{try{const{data:e,error:t}=await d.from("legendas_fotos").insert([r]).select().single();if(t)throw t;return e}catch(e){throw o.error("Erro ao adicionar legenda:",e),e}},m=async(r,e)=>{try{const{data:t,error:a}=await d.from("legendas_fotos").update(e).eq("id",r).select().single();if(a)throw a;return t}catch(t){throw o.error("Erro ao atualizar legenda:",t),t}},_=async r=>{try{const{error:e}=await d.from("legendas_fotos").delete().eq("id",r);if(e)throw e;return!0}catch(e){throw o.error("Erro ao deletar legenda:",e),e}},y=async(r,e,t,a="escola")=>{try{const n=await l(r,t,{tipo_foto:a,ativo:!1});if(!n)return o.debug(`Nenhuma legenda encontrada para transferir de ${r} para ${e}`),null;const s=await l(e,t,{tipo_foto:a,ativo:!1});if(s){const i={legenda:n.legenda||s.legenda,descricao_detalhada:n.descricao_detalhada||s.descricao_detalhada,autor_foto:n.autor_foto||s.autor_foto,data_foto:n.data_foto||s.data_foto,categoria:n.categoria||s.categoria,ordem:n.ordem!==null&&n.ordem!==void 0?n.ordem:s.ordem,ativo:!0,updated_at:new Date().toISOString()},c=await m(s.id,i);return n.id!==s.id&&await _(n.id),o.debug(`Legenda transferida e mesclada de ${r} para ${e}`),c}else{const i=await m(n.id,{imagem_url:e,updated_at:new Date().toISOString()});return o.debug(`Legenda transferida de ${r} para ${e}`),i}}catch(n){throw o.error("Erro ao transferir legenda:",n),n}},q=async(r,e)=>{try{const{data:t,error:a}=await d.from("legendas_fotos").select("*").eq("imagem_url",r).eq("escola_id",e).eq("categoria","video").single();if(a){if(a.code==="PGRST116")return null;throw a}return t}catch(t){return o.warn("Erro ao buscar tÃ­tulo do vÃ­deo:",t.message),null}},p=async(r,e,t)=>{try{const a=await l(r,e,{ativo:!1});if(a){const{data:n,error:s}=await d.from("legendas_fotos").update({ordem:t,updated_at:new Date().toISOString()}).eq("id",a.id).select().single();if(s)throw s;return n}else{const s=(r.split("/").pop()||"Imagem").replace(/\.[^/.]+$/,"").replace(/[_-]/g," ")||"Imagem",{data:i,error:c}=await d.from("legendas_fotos").insert([{escola_id:e,imagem_url:r,legenda:s,ordem:t,ativo:!0,tipo_foto:"escola",categoria:"geral",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select().single();if(c)throw c;return i}}catch(a){throw o.error("Erro ao atualizar ordem da imagem:",a),a}},E=async(r,e)=>{try{return await Promise.all(r.map(({imageUrl:a,ordem:n})=>p(a,e,n)))}catch(t){throw o.error("Erro ao atualizar ordens das imagens:",t),t}};export{b as addLegendaFoto,_ as deleteLegendaFoto,l as getLegendaByImageUrl,v as getLegendaByImageUrlFlexivel,q as getTituloByVideoUrl,h as testLegendasTable,y as transferLegendaToNewUrl,p as updateImageOrder,m as updateLegendaFoto,E as updateMultipleImageOrders};
